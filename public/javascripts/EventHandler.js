import DivContents from"./DivContents2.js";import NarniaEventHandler from"./NarniaEventHandler.js";import WebStorage from"./WebStorage.js";export default class EventHandler{constructor(e,t,l){this.signedIn=[],this.patrollers=e,this.dayNight=t,this.halfDay=!1,this.overMax=[!1,!1,!1,!1,!1],this.teamCounts=[0,0,0,0,0],this.isWeekend=l,this.buttons=document.querySelectorAll("input[type=button]"),new NarniaEventHandler(this.patrollers),this.handleWeekendOverride(),this.handleSignOnButtons(),this.validate(),EventHandler.stopEnterKey(),this.populatePage()}handleWeekendOverride(){this.isWeekend||"Day"!==this.dayNight?document.getElementById("weekendOverride").disabled=!0:document.getElementById("weekendOverride").addEventListener("click",()=>{if(document.getElementById("weekendOverride").checked){document.getElementById("weekendOverrideLabel").style.backgroundColor="yellow",document.getElementById("weekendOverrideP").style.backgroundColor="yellow",document.getElementById("team.0").style.display="none",this.isWeekend=!0;let e=1;const t=6;for(;e<=t;)document.getElementById("team.1").style.display="block",document.getElementById(`team.${e}`).style.display="block",e++;document.getElementById("formSubmit").disabled=!0}else{document.getElementById("weekendOverrideLabel").style.backgroundColor="rgb(213, 213, 213)",document.getElementById("weekendOverrideP").style.backgroundColor="rgb(213, 213, 213)",document.getElementById("team.0").style.display="block",this.isWeekend=!1;let e=1;const t=6;for(;e<=t;)document.getElementById(`team.${e}`).style.display="none",e++;document.getElementById("formSubmit").disabled=!0}})}handleSignOnButtons(){let e=[1,1,1,1,1,1,1];for(let t=0;t<this.buttons.length;t++)this.buttons[t].addEventListener("click",()=>{document.getElementById("weekendOverride").disabled=!0;let l=Number(this.buttons[t].id.substr(9,1));if(l>0)for(let e of this.buttons)document.getElementById(e.id).disabled=!0;if(6===l){let t=!1,n=prompt("What is your Patroller ID?");for(let o of this.patrollers){if(o.ID===n&&o.LEADER){t=!0;for(let e of this.buttons)document.getElementById(e.id).disabled=!0;document.getElementById(`team.${l}`).insertAdjacentHTML("beforeend",DivContents.getDivs(l,e[l],o.LEADER)),document.getElementById(`patrollerID.6.${e[l]}`).value=o.ID,this.handleUndo(l,e[l]),this.changePatrollerDiv(6,e[6]),"Day"===this.dayNight&&this.handleHalfDay(l,e[l]);let n=document.getElementById(`patrollerID.6.${e[l]}`),r=new Event("change");n.dispatchEvent(r),e[l]++;break}for(let e of this.buttons)document.getElementById(e.id).disabled=!1}t||alert("Incorrect ID for leadership/trainers team. Please try again or sign on to a different team.")}else this.buttons[t].disabled=!0,document.getElementById(`team.${l}`).insertAdjacentHTML("beforeend",DivContents.getDivs(l,e[l])),"Day"===this.dayNight&&this.handleHalfDay(l,e[l]),this.handleUndo(l,e[l]),this.changePatrollerDiv(l,e[l]),e[l]++})}changePatrollerDiv(e,t){document.getElementById(`patrollerID.${e}.${t}`).addEventListener("change",()=>{let l=!1;if(""!==document.getElementById(`patrollerID.${e}.${t}`).value)if(this.signedIn.length>0){for(let n=0;n<this.patrollers.length;n++){if(n<this.signedIn.length&&this.signedIn[n].ID===Number(document.getElementById(`patrollerID.${e}.${t}`).value)){alert("You are already logged in."),document.getElementById(`patrollerID.${e}.${t}`).value="";break}if(Number(this.patrollers[n].ID)===Number(document.getElementById(`patrollerID.${e}.${t}`).value)){document.getElementById(`patrollerID.${e}.${t}`).readOnly=!0,this.populateDiv(e,t,n),this.handleSnowmobile(e,t),this.handleToboggan(e,t),this.handleSplint(e,t),this.handleCpr(e,t),this.handleChair(e,t),document.getElementById(`radioNum.${e}.${t}`).required=!0,l=!0,document.getElementById(`radioNum.${e}.${t}`).addEventListener("change",()=>{console.log("Changing radio 1");let l=!1;for(let n of this.signedIn)document.getElementById(`radioNum.${e}.${t}`).value===n.RADIO&&"0"!==n.RADIO&&(l=!0);l?(alert("Radio already in use...."),document.getElementById(`radioNum.${e}.${t}`).value=""):this.updatePatrollerInfo(this.patrollers[n].ID,document.getElementById(`radioNum.${e}.${t}`).value,"radio")}),5!==e&&document.getElementById(`guest.${e}.${t}`).addEventListener("change",()=>{this.updatePatrollerInfo(this.patrollers[n].ID,document.getElementById(`guest.${e}.${t}`).value,"guest")}),this.isWeekend&&(this.teamCounts[e]++,this.enforceTeamBalance(e),e>0&&e<5&&this.handleAdmin(e,t));break}}!0!==l&&(alert("Invalid ID number. Please try again... Or don't..."),document.getElementById(`patrollerID.${e}.${t}`).value="")}else{for(let n=0;n<this.patrollers.length;n++)if(Number(this.patrollers[n].ID)===Number(document.getElementById(`patrollerID.${e}.${t}`).value)){document.getElementById(`patrollerID.${e}.${t}`).readOnly=!0,this.populateDiv(e,t,n),this.handleSnowmobile(e,t),this.handleToboggan(e,t),this.handleSplint(e,t),this.handleCpr(e,t),this.handleChair(e,t),document.getElementById(`radioNum.${e}.${t}`).required=!0,l=!0,document.getElementById(`radioNum.${e}.${t}`).addEventListener("change",()=>{console.log("Changing radio 2"),this.updatePatrollerInfo(this.patrollers[n].ID,document.getElementById(`radioNum.${e}.${t}`).value,"radio")}),5!==e&&document.getElementById(`guest.${e}.${t}`).addEventListener("change",()=>{this.updatePatrollerInfo(this.patrollers[n].ID,document.getElementById(`guest.${e}.${t}`).value,"guest")}),this.isWeekend&&(this.teamCounts[e]++,this.enforceTeamBalance(e),e>0&&e<5&&this.handleAdmin(e,t));break}l||(alert("Invalid ID number. Please try again... Or don't..."),document.getElementById(`patrollerID.${e}.${t}`).value="")}else this.clearDiv(e,t)})}updatePatrollerInfo(e,t,l){for(let n of this.signedIn)if(Number(n.ID)===Number(e)){"radio"===l?n.RADIO=t:"guest"===l?n.GUEST=t:"halfDaysDown"===l?(n.TODAY_HALF=!1,n.TOTAL_DAYS=t,n.DAYS++,n.HALF_DAYS>0&&n.HALF_DAYS--,alert(`TOTAL DAYS:  ${Number(n.TOTAL_DAYS)}`)):"halfDaysUp"===l&&(n.TODAY_HALF=!0,n.TOTAL_DAYS=t,n.HALF_DAYS++,n.DAYS>0&&n.DAYS--,alert(`TOTAL DAYS:  ${Number(n.TOTAL_DAYS)-.5}`)),WebStorage.populateLocalStorage(n,n.POSITION_TEAM);break}}populateDiv(e,t,l){let n,o=new Date,r=o.getMinutes();r<10&&(r=`0${r}`);let d=1,s=0,i=0;!0===this.halfDay&&(s=1,d=0),"Night"===this.dayNight&&(i=1,d=0),document.getElementById(`time.${e}.${t}`).value=`${o.getHours()}:${r}`,document.getElementById(`race.${e}.${t}`)&&(n=document.getElementById(`race.${e}.${t}`).value),this.patrollers[l].DAYS=Number(this.patrollers[l].DAYS),this.patrollers[l].NIGHTS=Number(this.patrollers[l].NIGHTS),this.patrollers[l].HALF_DAYS=Number(this.patrollers[l].HALF_DAYS);let a=this.patrollers[l].DAYS+d,m=this.patrollers[l].NIGHTS+i,u=this.patrollers[l].HALF_DAYS+s,h=a+m+u/2,g={ID:Number(this.patrollers[l].ID),RADIO:document.getElementById(`radioNum.${e}.${t}`).value,NAME:`${this.patrollers[l].FIRST_NAME} ${this.patrollers[l].LAST_NAME}`,RATING:this.patrollers[l].RATING,TIME:document.getElementById(`time.${e}.${t}`).value,DAYS:a,TEAM:e,RACE:n,NIGHTS:m,HALF_DAYS:u,TOTAL_DAYS:h,SNOWMOBILE:this.patrollers[l].SNOWMOBILE,TOBOGGAN:this.patrollers[l].TOBOGGAN,SPLINT:this.patrollers[l].SPLINT,CPR:this.patrollers[l].CPR,CHAIR:this.patrollers[l].CHAIR,TODAY_HALF:!1,POSITION_TEAM:t};5!==e&&(g.GUEST=document.getElementById(`guest.${e}.${t}`).value),alert(`TOTAL DAYS: ${g.TOTAL_DAYS}`),this.signedIn.push(g),document.getElementById(`name.${e}.${t}`).value=`${this.patrollers[l].FIRST_NAME} ${this.patrollers[l].LAST_NAME}`,document.getElementById(`rating.${e}.${t}`).value=this.patrollers[l].RATING}clearDiv(e,t){let l,n=document.getElementsByName("patrollerID"),o=[];for(let e=0;e<n.length;e++)o.push(Number(n[e].value));for(let e=0;e<this.signedIn.length;e++)-1===this.signedIn.indexOf(o[e].ID)&&(l=this.signedIn[e].ID);this.signedIn.splice(this.signedIn.indexOf(l),1),document.getElementById(`name.${e}.${t}`).value="",document.getElementById(`radioNum.${e}.${t}`).value="",document.getElementById(`rating.${e}.${t}`).value="",document.getElementById(`time.${e}.${t}`).value="",document.getElementById(`halfDay.${e}.${t}`).checked=!1,5!==e&&(document.getElementById(`guest.${e}.${t}`).value=""),document.getElementById(`person.${e}.${t}`).outerHTML="",this.teamCounts[e]--}handleHalfDay(e,t){if((new Date).getHours()>9){document.getElementById(`halfDay.${e}.${t}`).setAttribute("checked","checked"),document.getElementById(`halfDay.${e}.${t}`).disabled=!0,5!==e&&(document.getElementById(`guestDiv.${e}.${t}`).style.visibility="hidden");for(let l of this.signedIn)if(Number(l.ID)===Number(document.getElementById(`patrollerID.${e}.${t}`).value)){this.updatePatrollerInfo(l.ID,l.TOTAL_DAYS,"halfDaysUp");break}this.halfDay=!0}else document.getElementById(`halfDay.${e}.${t}`).addEventListener("click",()=>{if(document.getElementById(`halfDay.${e}.${t}`).checked){document.getElementById(`person.${e}.${t}`).style.backgroundColor="rgb(247,223,30)",5!==e&&(document.getElementById(`guest.${e}.${t}`).disabled=!0);for(let l of this.signedIn)if(Number(l.ID)===Number(document.getElementById(`patrollerID.${e}.${t}`).value)){this.updatePatrollerInfo(l.ID,l.TOTAL_DAYS,"halfDaysUp");break}}else{document.getElementById(`person.${e}.${t}`).style.backgroundColor="white",5!==e&&(document.getElementById(`guest.${e}.${t}`).disabled=!1);for(let l of this.signedIn)if(Number(l.ID)===Number(document.getElementById(`patrollerID.${e}.${t}`).value)){this.updatePatrollerInfo(l.ID,l.TOTAL_DAYS,"halfDaysDown");break}}})}handleSnowmobile(e,t){for(let l=0;l<this.signedIn.length;l++)if(Number(this.signedIn[l].ID)===Number(document.getElementById(`patrollerID.${e}.${t}`).value)){if(1!==Number(this.signedIn[l].SNOWMOBILE)){document.getElementById(`snowmobile.${e}.${t}`).style.color="rgb(204,75,55)";let n,o=!1;document.getElementById(`snowmobile.${e}.${t}`).addEventListener("click",n=()=>{let r=prompt("Password: ");for(let e of this.patrollers)e.ID===r&&e.LEADER&&(o=!0);o?(this.signedIn[l].SNOWMOBILE=1,document.getElementById(`snowmobile.${e}.${t}`).style.color="rgb(23,121,186)",document.getElementById(`snowmobile.${e}.${t}`).removeEventListener("click",n),document.getElementById(`snowmobile.${e}.${t}`).style.cursor="default"):alert("Incorrect Password")})}else document.getElementById(`snowmobile.${e}.${t}`).style.color="rgb(23,121,186)",document.getElementById(`snowmobile.${e}.${t}`).style.cursor="default";break}}handleToboggan(e,t){for(let l=0;l<this.signedIn.length;l++)if(Number(this.signedIn[l].ID)===Number(document.getElementById(`patrollerID.${e}.${t}`).value)){if(1!==Number(this.signedIn[l].TOBOGGAN)){document.getElementById(`toboggan.${e}.${t}`).style.color="rgb(204,75,55)";let n,o=!1;document.getElementById(`toboggan.${e}.${t}`).addEventListener("click",n=()=>{let r=prompt("Password: ");for(let e of this.patrollers)e.ID===r&&e.LEADER&&(o=!0);o?(this.signedIn[l].TOBOGGAN=1,document.getElementById(`toboggan.${e}.${t}`).style.color="rgb(23,121,186)",document.getElementById(`toboggan.${e}.${t}`).removeEventListener("click",n),document.getElementById(`toboggan.${e}.${t}`).style.cursor="default"):alert("Incorrect Password")})}else document.getElementById(`toboggan.${e}.${t}`).style.color="rgb(23,121,186)",document.getElementById(`toboggan.${e}.${t}`).style.cursor="default";break}}handleSplint(e,t){for(let l=0;l<this.signedIn.length;l++)if(Number(this.signedIn[l].ID)===Number(document.getElementById(`patrollerID.${e}.${t}`).value)){if(1!==Number(this.signedIn[l].SPLINT)){document.getElementById(`splint.${e}.${t}`).style.color="rgb(204,75,55)";let n,o=!1;document.getElementById(`splint.${e}.${t}`).addEventListener("click",n=()=>{let r=prompt("Password: ");for(let e of this.patrollers)e.ID===r&&e.LEADER&&(o=!0);o?(this.signedIn[l].SPLINT=1,document.getElementById(`splint.${e}.${t}`).style.color="rgb(23,121,186)",document.getElementById(`splint.${e}.${t}`).removeEventListener("click",n),document.getElementById(`splint.${e}.${t}`).style.cursor="default"):alert("Incorrect Password")})}else document.getElementById(`splint.${e}.${t}`).style.color="rgb(23,121,186)",document.getElementById(`splint.${e}.${t}`).style.cursor="default";break}}handleCpr(e,t){for(let l=0;l<this.signedIn.length;l++)if(Number(this.signedIn[l].ID)===Number(document.getElementById(`patrollerID.${e}.${t}`).value)){if(1!==Number(this.signedIn[l].CPR)){document.getElementById(`cpr.${e}.${t}`).style.color="rgb(204,75,55)";let n,o=!1;document.getElementById(`cpr.${e}.${t}`).addEventListener("click",n=()=>{let r=prompt("Password: ");for(let e of this.patrollers)e.ID===r&&e.LEADER&&(o=!0);o?(this.signedIn[l].CPR=1,document.getElementById(`cpr.${e}.${t}`).style.color="rgb(23,121,186)",document.getElementById(`cpr.${e}.${t}`).removeEventListener("click",n),document.getElementById(`cpr.${e}.${t}`).style.cursor="default"):alert("Incorrect Password")})}else document.getElementById(`cpr.${e}.${t}`).style.color="rgb(23,121,186)",document.getElementById(`cpr.${e}.${t}`).style.cursor="default";break}}handleChair(e,t){for(let l=0;l<this.signedIn.length;l++)if(Number(this.signedIn[l].ID)===Number(document.getElementById(`patrollerID.${e}.${t}`).value)){if(1!==Number(this.signedIn[l].CHAIR)){document.getElementById(`chair.${e}.${t}`).style.color="rgb(204,75,55)";let n,o=!1;document.getElementById(`chair.${e}.${t}`).addEventListener("click",n=()=>{let r=prompt("Password: ");for(let e of this.patrollers)e.ID===r&&e.LEADER&&(o=!0);o?(this.signedIn[l].CHAIR=1,document.getElementById(`chair.${e}.${t}`).style.color="rgb(23,121,186)",document.getElementById(`chair.${e}.${t}`).removeEventListener("click",n),document.getElementById(`chair.${e}.${t}`).style.cursor="default"):alert("Incorrect Password")})}else document.getElementById(`chair.${e}.${t}`).style.color="rgb(23,121,186)",document.getElementById(`chair.${e}.${t}`).style.cursor="default";break}}static stopEnterKey(){document.addEventListener("keypress",e=>{let t=e.which;13!==t&&169!==t||e.preventDefault()})}handlePrintFormButton(){document.getElementById("formSubmit").addEventListener("click",e=>{console.log("Print button clicked"),e.stopImmediatePropagation(),this.updateDays(),document.getElementById("formSubmit").disabled=!0;for(let e of this.buttons)document.getElementById(e.id).disabled=!0;window.open("/public/views/results.ejs","_blank","location=yes,height=900,width=1000,scrollbars=yes,status=yes"),WebStorage.purgeLocalStorage()})}enforceTeamBalance(e){if(this.teamCounts[e]>=4&&(this.overMax[e]=!0),this.teamCounts[1]>=4&&this.teamCounts[2]>=4&&this.teamCounts[3]>=4&&this.teamCounts[4]>=4)for(let e=1;e<this.overMax.length;e++)this.overMax[e]=!1}validate(){document.addEventListener("change",()=>{if(window.event.target!==document.getElementById("weekendOverride")){let e=document.getElementById("rosterForm"),t=!0;if(this.isWeekend&&"Day"===this.dayNight){for(let l=0;l<e.elements.length;l++)e.elements[l].hasAttribute("required")&&!e.elements[l].value&&(t=!1);if(t){for(let e of this.buttons)document.getElementById(e.id).disabled=!1;for(let e=1;e<this.overMax.length;e++)this.overMax[e]&&(document.getElementById(`joinTeam.${e}`).disabled=!0);let e=document.getElementById("radioNum.6.1");e&&e.value&&(document.getElementById("formSubmit").disabled=!1,this.handlePrintFormButton())}}else{for(let l=0;l<e.elements.length;l++)e.elements[l].hasAttribute("required")&&!e.elements[l].value&&(t=!1);t&&(document.getElementById("joinTeam.0").disabled=!1,document.getElementById("formSubmit").disabled=!1,this.handlePrintFormButton())}}})}handleAdmin(e,t){let l=!1;document.getElementById(`admin.${e}.${t}`).addEventListener("click",()=>{let n=prompt("Password: ");for(let e of this.patrollers)e.ID===n&&e.LEADER&&(l=!0);if(l){const l=1,n=4;let o=prompt("Move to which team?");if(o<l||o>n)alert("Incorrect team number.");else if(Number(o)===Number(e))alert("Patroller is already in this team!");else{let l=document.getElementById(`person.${e}.${t}`);document.getElementById(`team.${o}`).appendChild(l),this.teamCounts[o]++,this.teamCounts[e]--,this.enforceTeamBalance(o)}}else alert("Incorrect Password")})}handleUndo(e,t){document.getElementById(`undo.${e}.${t}`).addEventListener("click",()=>{this.clearDiv(e,t);for(let e of this.buttons)document.getElementById(e.id).disabled=!1})}populatePage(){WebStorage.checkLocalStorage()&&WebStorage.populateForm(this.isWeekend,this.dayNight)}updateDays(){for(let e=0;e<this.patrollers.length;e++)for(let t=0;t<this.signedIn.length;t++)if(Number(this.patrollers[e].ID)===Number(this.signedIn[t].ID)){console.log(`Updating ${this.patrollers[e].LAST_NAME} days....`),this.patrollers[e].DAYS=this.signedIn[t].DAYS,this.patrollers[e].NIGHTS=this.signedIn[t].NIGHTS,this.patrollers[e].HALF_DAYS=this.signedIn[t].HALF_DAYS,this.patrollers[e].SNOWMOBILE=this.signedIn[t].SNOWMOBILE,this.patrollers[e].TOBOGGAN=this.signedIn[t].TOBOGGAN,this.patrollers[e].SPLINT=this.signedIn[t].SPLINT,this.patrollers[e].CPR=this.signedIn[t].CPR,this.patrollers[e].CHAIR=this.signedIn[t].CHAIR;break}fetch(document.url,{method:"POST",body:JSON.stringify(this.patrollers),headers:{"x-requested-with":"fetch.1",mode:"no-cors"}}).then(e=>{console.log(e.json())}),fetch(document.url,{method:"POST",body:JSON.stringify(this.signedIn),headers:{"x-requested-with":"fetch.2",mode:"no-cors"}}).then(e=>e.json())}}