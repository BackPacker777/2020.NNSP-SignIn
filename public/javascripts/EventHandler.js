import DivContents from"./DivContents2.js";import NarniaEventHandler from"./NarniaEventHandler.js";import WebStorage from"./WebStorage.js";export default class EventHandler{constructor(e,t,n,l){this.SIGN_OFFS=l,this.nightCounter=0,this.signedIn=[],this.patrollers=e,this.dayNight=t,this.halfDay=!1,this.overMax=[!1,!1,!1,!1,!1],this.teamCounts=[0,0,0,0,0],this.isWeekend=n,this.populated=0,this.buttons=document.querySelectorAll("input[type=button]"),new NarniaEventHandler(this.patrollers,this.SIGN_OFFS),this.handleWeekendOverride(),this.handleSignOnButtons(),this.validate(),EventHandler.stopEnterKey()}handleWeekendOverride(){this.isWeekend||"Day"!==this.dayNight?document.getElementById("weekendOverride").disabled=!0:document.getElementById("weekendOverride").addEventListener("click",()=>{if(document.getElementById("weekendOverride").checked){document.getElementById("weekendOverrideLabel").style.backgroundColor="yellow",document.getElementById("weekendOverrideP").style.backgroundColor="yellow",document.getElementById("team.0").style.display="none",this.isWeekend=!0;let e=1;const t=6;for(;e<=t;)document.getElementById("team.1").style.display="block",document.getElementById(`team.${e}`).style.display="block",e++;document.getElementById("formSubmit").disabled=!0}else{document.getElementById("weekendOverrideLabel").style.backgroundColor="rgb(213, 213, 213)",document.getElementById("weekendOverrideP").style.backgroundColor="rgb(213, 213, 213)",document.getElementById("team.0").style.display="block",this.isWeekend=!1;let e=1;const t=6;for(;e<=t;)document.getElementById(`team.${e}`).style.display="none",e++;document.getElementById("formSubmit").disabled=!0}})}handleSignOnButtons(){let e=[1,1,1,1,1,1,1],t=9;for(let n=0;n<this.buttons.length;n++){Number(this.buttons[n].id.substr(9,1));this.buttons[n].addEventListener("click",()=>{document.getElementById("weekendOverride").disabled=!0;let l=Number(this.buttons[n].id.substr(9,1));if(l>0)for(let e of this.buttons)document.getElementById(e.id).disabled=!0;if(6===l){let t=!1,n=prompt("What is your Patroller ID?");for(let r of this.patrollers){if(r.ID===n&&r.LEADER){t=!0;for(let e of this.buttons)document.getElementById(e.id).disabled=!0;document.getElementById(`team.${l}`).insertAdjacentHTML("beforeend",DivContents.getDivs(l,e[l],r.LEADER)),document.getElementById(`patrollerID.6.${e[l]}`).value=r.ID,this.handleUndo(l,e[l]),this.changePatrollerDiv(6,e[6]),"Day"===this.dayNight&&this.handleHalfDay(l,e[l]);let n=document.getElementById(`patrollerID.6.${e[l]}`),o=new Event("change");n.dispatchEvent(o),e[l]++;break}for(let e of this.buttons)document.getElementById(e.id).disabled=!1}t||alert("Incorrect ID for leadership/trainers team. Please try again or sign on to a different team.")}else 0===l&&"Night"===this.dayNight?(document.getElementById(`team.${l}`).insertAdjacentHTML("beforeend",DivContents.getExtraNightDiv(l,t)),this.changePatrollerDiv(l,t),t++):(this.buttons[n].disabled=!0,document.getElementById(`team.${l}`).insertAdjacentHTML("beforeend",DivContents.getDivs(l,e[l])),"Day"===this.dayNight&&this.handleHalfDay(l,e[l]),this.handleUndo(l,e[l]),this.changePatrollerDiv(l,e[l]),e[l]++)})}}changePatrollerDiv(e,t){document.getElementById(`patrollerID.${e}.${t}`).addEventListener("change",()=>{let n=!1;if(""!==document.getElementById(`patrollerID.${e}.${t}`).value)if(this.signedIn.length>0){for(let l=0;l<this.patrollers.length;l++){if(l<this.signedIn.length&&this.signedIn[l].ID===Number(document.getElementById(`patrollerID.${e}.${t}`).value)){alert("You are already logged in."),document.getElementById(`patrollerID.${e}.${t}`).value="";break}if(Number(this.patrollers[l].ID)===Number(document.getElementById(`patrollerID.${e}.${t}`).value)){document.getElementById(`patrollerID.${e}.${t}`).readOnly=!0,this.populateDiv(e,t,l),this.handleSnowmobile(e,t),this.handleToboggan(e,t),this.handleScavenger(e,t),this.handleCpr(e,t),this.handleChair(e,t),document.getElementById(`radioNum.${e}.${t}`).required=!0,n=!0,document.getElementById(`radioNum.${e}.${t}`).addEventListener("change",()=>{let n=!1;for(let l of this.signedIn)document.getElementById(`radioNum.${e}.${t}`).value===l.RADIO&&"0"!==l.RADIO&&(n=!0);n?(alert("Radio already in use...."),document.getElementById(`radioNum.${e}.${t}`).value=""):this.updatePatrollerInfo(this.patrollers[l].ID,document.getElementById(`radioNum.${e}.${t}`).value,"radio")}),5!==e&&document.getElementById(`guest.${e}.${t}`).addEventListener("change",()=>{this.updatePatrollerInfo(this.patrollers[l].ID,document.getElementById(`guest.${e}.${t}`).value,"guest")}),this.isWeekend&&(this.teamCounts[e]++,e>0&&this.enforceTeamBalance(e),e>0&&e<5&&this.handleAdmin(e,t));break}}!0!==n&&(alert("Invalid ID number. Please try again... Or don't..."),document.getElementById(`patrollerID.${e}.${t}`).value="")}else{for(let l=0;l<this.patrollers.length;l++)if(Number(this.patrollers[l].ID)===Number(document.getElementById(`patrollerID.${e}.${t}`).value)){document.getElementById(`patrollerID.${e}.${t}`).readOnly=!0,this.populateDiv(e,t,l),this.handleSnowmobile(e,t),this.handleToboggan(e,t),this.handleScavenger(e,t),this.handleCpr(e,t),this.handleChair(e,t),document.getElementById(`radioNum.${e}.${t}`).required=!0,n=!0,document.getElementById(`radioNum.${e}.${t}`).addEventListener("change",()=>{this.updatePatrollerInfo(this.patrollers[l].ID,document.getElementById(`radioNum.${e}.${t}`).value,"radio")}),5!==e&&document.getElementById(`guest.${e}.${t}`).addEventListener("change",()=>{this.updatePatrollerInfo(this.patrollers[l].ID,document.getElementById(`guest.${e}.${t}`).value,"guest")}),this.isWeekend&&(this.teamCounts[e]++,e>0&&this.enforceTeamBalance(e),e>0&&e<5&&this.handleAdmin(e,t));break}n||(alert("Invalid ID number. Please try again... Or don't..."),document.getElementById(`patrollerID.${e}.${t}`).value="")}else this.clearDiv(e,t)})}updatePatrollerInfo(e,t,n){for(let l of this.signedIn)if(Number(l.ID)===Number(e)){"radio"===n?l.RADIO=t:"guest"===n?l.GUEST=t:"halfDaysDown"===n?(l.TODAY_HALF=!1,l.TOTAL_DAYS=t,l.DAYS++,l.HALF_DAYS>0&&l.HALF_DAYS--,0===this.populated&&alert(`TOTAL DAYS:  ${Number(l.TOTAL_DAYS)}`)):"halfDaysUp"===n&&(l.TODAY_HALF=!0,l.TOTAL_DAYS=t,l.HALF_DAYS++,l.DAYS>0&&l.DAYS--,0===this.populated&&alert(`TOTAL DAYS:  ${Number(l.TOTAL_DAYS)-.5}`)),0===this.populated&&WebStorage.populateLocalStorage(l,l.POSITION_TEAM);break}}populateDiv(e,t,n){let l,r=new Date,o=r.getMinutes();o<10&&(o=`0${o}`);let d=1,s=0,a=0;!0===this.halfDay&&(s=1,d=0),"Night"===this.dayNight&&(a=1,d=0),document.getElementById(`time.${e}.${t}`).value||(document.getElementById(`time.${e}.${t}`).value=`${r.getHours()}:${o}`),document.getElementById(`race.${e}.${t}`)&&(l=document.getElementById(`race.${e}.${t}`).value),this.patrollers[n].DAYS=Number(this.patrollers[n].DAYS),this.patrollers[n].NIGHTS=Number(this.patrollers[n].NIGHTS),this.patrollers[n].HALF_DAYS=Number(this.patrollers[n].HALF_DAYS);let i=this.patrollers[n].DAYS+d,m=this.patrollers[n].NIGHTS+a,u=this.patrollers[n].HALF_DAYS+s,h=i+m+u/2,g={ID:Number(this.patrollers[n].ID),RADIO:document.getElementById(`radioNum.${e}.${t}`).value,NAME:`${this.patrollers[n].FIRST_NAME} ${this.patrollers[n].LAST_NAME}`,RATING:this.patrollers[n].RATING,TIME:document.getElementById(`time.${e}.${t}`).value,DAYS:i,TEAM:e,RACE:l,NIGHTS:m,HALF_DAYS:u,TOTAL_DAYS:h,SNOWMOBILE:this.patrollers[n].SNOWMOBILE,TOBOGGAN:this.patrollers[n].TOBOGGAN,SCAVENGER:this.patrollers[n].SCAVENGER,CPR:this.patrollers[n].CPR,CHAIR:this.patrollers[n].CHAIR,TODAY_HALF:!1,POSITION_TEAM:t};5!==e&&(g.GUEST=document.getElementById(`guest.${e}.${t}`).value),0===this.populated&&alert(`TOTAL DAYS: ${g.TOTAL_DAYS}`),this.signedIn.push(g),document.getElementById(`name.${e}.${t}`).value=`${this.patrollers[n].FIRST_NAME} ${this.patrollers[n].LAST_NAME}`,document.getElementById(`rating.${e}.${t}`).value=this.patrollers[n].RATING}clearDiv(e,t){let n,l=document.getElementsByName("patrollerID"),r=[];for(let e=0;e<l.length;e++)r.push(Number(l[e].value));for(let e=0;e<this.signedIn.length;e++)-1===this.signedIn.indexOf(r[e].ID)&&(n=this.signedIn[e].ID);this.signedIn.splice(this.signedIn.indexOf(n),1),document.getElementById(`name.${e}.${t}`).value="",document.getElementById(`radioNum.${e}.${t}`).value="",document.getElementById(`rating.${e}.${t}`).value="",document.getElementById(`time.${e}.${t}`).value="",document.getElementById(`halfDay.${e}.${t}`).checked=!1,5!==e&&(document.getElementById(`guest.${e}.${t}`).value=""),document.getElementById(`person.${e}.${t}`).outerHTML="",this.teamCounts[e]--}handleHalfDay(e,t){if((new Date).getHours()>9){document.getElementById(`halfDay.${e}.${t}`).setAttribute("checked","checked"),document.getElementById(`halfDay.${e}.${t}`).disabled=!0,5!==e&&(document.getElementById(`guestDiv.${e}.${t}`).style.visibility="hidden"),this.teamCounts[e]--,this.enforceTeamBalance(e);for(let n of this.signedIn)if(Number(n.ID)===Number(document.getElementById(`patrollerID.${e}.${t}`).value)){this.updatePatrollerInfo(n.ID,n.TOTAL_DAYS,"halfDaysUp");break}this.halfDay=!0}else document.getElementById(`halfDay.${e}.${t}`).addEventListener("click",()=>{if(document.getElementById(`halfDay.${e}.${t}`).checked){document.getElementById(`person.${e}.${t}`).style.backgroundColor="rgb(247,223,30)",5!==e&&(document.getElementById(`guest.${e}.${t}`).disabled=!0),this.teamCounts[e]--,this.enforceTeamBalance(e);for(let n of this.signedIn)if(Number(n.ID)===Number(document.getElementById(`patrollerID.${e}.${t}`).value)){this.updatePatrollerInfo(n.ID,n.TOTAL_DAYS,"halfDaysUp");break}}else{document.getElementById(`person.${e}.${t}`).style.backgroundColor="white",5!==e&&(document.getElementById(`guest.${e}.${t}`).disabled=!1),this.teamCounts[e]++,this.enforceTeamBalance(e);for(let n of this.signedIn)if(Number(n.ID)===Number(document.getElementById(`patrollerID.${e}.${t}`).value)){this.updatePatrollerInfo(n.ID,n.TOTAL_DAYS,"halfDaysDown");break}}})}handleSnowmobile(e,t){for(let n=0;n<this.signedIn.length;n++)if(Number(this.signedIn[n].ID)===Number(document.getElementById(`patrollerID.${e}.${t}`).value)){if(1!==Number(this.signedIn[n].SNOWMOBILE)){document.getElementById(`snowmobile.${e}.${t}`).style.color="rgb(204,75,55)";let l,r=!1;document.getElementById(`snowmobile.${e}.${t}`).addEventListener("click",l=()=>{let o=prompt("Password: ");for(let e of this.patrollers)e.ID===o&&e.LEADER&&(r=!0);r?(this.signedIn[n].SNOWMOBILE=1,document.getElementById(`snowmobile.${e}.${t}`).style.color="rgb(23,121,186)",document.getElementById(`snowmobile.${e}.${t}`).removeEventListener("click",l),document.getElementById(`snowmobile.${e}.${t}`).style.cursor="default"):alert("Incorrect Password")})}else document.getElementById(`snowmobile.${e}.${t}`).style.color="rgb(23,121,186)",document.getElementById(`snowmobile.${e}.${t}`).style.cursor="default";break}}handleToboggan(e,t){for(let n=0;n<this.signedIn.length;n++)if(Number(this.signedIn[n].ID)===Number(document.getElementById(`patrollerID.${e}.${t}`).value)){if(1!==Number(this.signedIn[n].TOBOGGAN)){document.getElementById(`toboggan.${e}.${t}`).style.color="rgb(204,75,55)";let l,r=!1;document.getElementById(`toboggan.${e}.${t}`).addEventListener("click",l=()=>{let o=prompt("Password: ");for(let e of this.patrollers)e.ID===o&&e.LEADER&&(r=!0);r?(this.signedIn[n].TOBOGGAN=1,document.getElementById(`toboggan.${e}.${t}`).style.color="rgb(23,121,186)",document.getElementById(`toboggan.${e}.${t}`).removeEventListener("click",l),document.getElementById(`toboggan.${e}.${t}`).style.cursor="default"):alert("Incorrect Password")})}else document.getElementById(`toboggan.${e}.${t}`).style.color="rgb(23,121,186)",document.getElementById(`toboggan.${e}.${t}`).style.cursor="default";break}}handleScavenger(e,t){for(let n=0;n<this.signedIn.length;n++)if(Number(this.signedIn[n].ID)===Number(document.getElementById(`patrollerID.${e}.${t}`).value)){if(1!==Number(this.signedIn[n].SCAVENGER)){document.getElementById(`scavenger.${e}.${t}`).style.color="rgb(204,75,55)";let l,r=!1;document.getElementById(`scavenger.${e}.${t}`).addEventListener("click",l=()=>{let o=prompt("Password: ");for(let e of this.patrollers)e.ID===o&&e.LEADER&&(r=!0);r?(this.signedIn[n].SCAVENGER=1,document.getElementById(`scavenger.${e}.${t}`).style.color="rgb(23,121,186)",document.getElementById(`scavenger.${e}.${t}`).removeEventListener("click",l),document.getElementById(`scavenger.${e}.${t}`).style.cursor="default"):alert("Incorrect Password")})}else document.getElementById(`scavenger.${e}.${t}`).style.color="rgb(23,121,186)",document.getElementById(`scavenger.${e}.${t}`).style.cursor="default";break}}handleCpr(e,t){for(let n=0;n<this.signedIn.length;n++)if(Number(this.signedIn[n].ID)===Number(document.getElementById(`patrollerID.${e}.${t}`).value)){if(1!==Number(this.signedIn[n].CPR)){document.getElementById(`cpr.${e}.${t}`).style.color="rgb(204,75,55)";let l,r=!1;document.getElementById(`cpr.${e}.${t}`).addEventListener("click",l=()=>{let o=prompt("Password: ");for(let e of this.patrollers)e.ID===o&&e.LEADER&&(r=!0);r?(this.signedIn[n].CPR=1,document.getElementById(`cpr.${e}.${t}`).style.color="rgb(23,121,186)",document.getElementById(`cpr.${e}.${t}`).removeEventListener("click",l),document.getElementById(`cpr.${e}.${t}`).style.cursor="default"):alert("Incorrect Password")})}else document.getElementById(`cpr.${e}.${t}`).style.color="rgb(23,121,186)",document.getElementById(`cpr.${e}.${t}`).style.cursor="default";break}}handleChair(e,t){for(let n=0;n<this.signedIn.length;n++)if(Number(this.signedIn[n].ID)===Number(document.getElementById(`patrollerID.${e}.${t}`).value)){if(1!==Number(this.signedIn[n].CHAIR)){document.getElementById(`chair.${e}.${t}`).style.color="rgb(204,75,55)";let l,r=!1;document.getElementById(`chair.${e}.${t}`).addEventListener("click",l=()=>{let o=prompt("Password: ");for(let e of this.patrollers)e.ID===o&&e.LEADER&&(r=!0);r?(this.signedIn[n].CHAIR=1,document.getElementById(`chair.${e}.${t}`).style.color="rgb(23,121,186)",document.getElementById(`chair.${e}.${t}`).removeEventListener("click",l),document.getElementById(`chair.${e}.${t}`).style.cursor="default"):alert("Incorrect Password")})}else document.getElementById(`chair.${e}.${t}`).style.color="rgb(23,121,186)",document.getElementById(`chair.${e}.${t}`).style.cursor="default";break}}static stopEnterKey(){document.addEventListener("keypress",e=>{let t=e.which;13!==t&&169!==t||e.preventDefault()})}handlePrintFormButton(){document.getElementById("formSubmit").addEventListener("click",e=>{e.stopImmediatePropagation();let t=prompt("Are you sure you want to clear & print the roster? Please type:  yes");if(console.log("Print button clicked"),"yes"===t){this.updateDays(),document.getElementById("formSubmit").disabled=!0;for(let e of this.buttons)document.getElementById(e.id).disabled=!0;window.open("/public/views/results.ejs","_blank","location=yes,height=900,width=1000,scrollbars=yes,status=yes"),WebStorage.purgeLocalStorage()}})}enforceTeamBalance(e){if(e>0){const t=4;if(this.teamCounts[e]>=t?this.overMax[e]=!0:this.overMax[e]=!1,this.teamCounts[1]>=t&&this.teamCounts[2]>=t&&this.teamCounts[3]>=t&&this.teamCounts[4]>=t)for(let e=1;e<this.overMax.length;e++)this.overMax[e]=!1}}validate(){document.addEventListener("change",()=>{if(window.event.target!==document.getElementById("weekendOverride")){let e=document.getElementById("rosterForm"),t=!0;if(this.isWeekend&&"Day"===this.dayNight){for(let n=0;n<e.elements.length;n++)e.elements[n].hasAttribute("required")&&!e.elements[n].value&&(t=!1);if(t){for(let e of this.buttons)document.getElementById(e.id).disabled=!1;for(let e=1;e<this.overMax.length;e++)this.overMax[e]&&(document.getElementById(`joinTeam.${e}`).disabled=!0);if("on"===document.getElementById("weekendOverride").value)document.getElementById("formSubmit").disabled=!1,this.handlePrintFormButton();else{let e=document.getElementById("radioNum.6.1");e&&e.value&&(document.getElementById("formSubmit").disabled=!1,this.handlePrintFormButton())}}}else{for(let n=0;n<e.elements.length;n++)e.elements[n].hasAttribute("required")&&!e.elements[n].value&&(t=!1);t?(console.log("valid"),document.getElementById("joinTeam.0").disabled=!1,document.getElementById("formSubmit").disabled=!1,this.handlePrintFormButton()):console.log("not valid")}}})}handleAdmin(e,t){let n=!1;document.getElementById(`admin.${e}.${t}`).addEventListener("click",()=>{let l=prompt("Password: ");for(let e of this.patrollers)e.ID===l&&e.LEADER&&(n=!0);if(n){const n=1,l=4;let r=prompt("Move to which team?");if(r<n||r>l)alert("Incorrect team number.");else if(Number(r)===Number(e))alert("Patroller is already in this team!");else{let n=document.getElementById(`person.${e}.${t}`);document.getElementById(`team.${r}`).appendChild(n),this.teamCounts[r]++,this.teamCounts[e]--,this.enforceTeamBalance(r)}}else alert("Incorrect Password")})}handleUndo(e,t){document.getElementById(`undo.${e}.${t}`).addEventListener("click",()=>{this.clearDiv(e,t);for(let e of this.buttons)document.getElementById(e.id).disabled=!1})}populatePage(){WebStorage.checkLocalStorage()&&(this.populated=1,WebStorage.populateForm(this.isWeekend,this.dayNight)),this.validate()}updateDays(){for(let e=0;e<this.patrollers.length;e++)for(let t=0;t<this.signedIn.length;t++)if(Number(this.patrollers[e].ID)===Number(this.signedIn[t].ID)){console.log(`Updating ${this.patrollers[e].LAST_NAME} days....`),this.patrollers[e].DAYS=this.signedIn[t].DAYS,this.patrollers[e].NIGHTS=this.signedIn[t].NIGHTS,this.patrollers[e].HALF_DAYS=this.signedIn[t].HALF_DAYS,this.patrollers[e].SNOWMOBILE=this.signedIn[t].SNOWMOBILE,this.patrollers[e].TOBOGGAN=this.signedIn[t].TOBOGGAN,this.patrollers[e].SCAVENGER=this.signedIn[t].SCAVENGER,this.patrollers[e].CPR=this.signedIn[t].CPR,this.patrollers[e].CHAIR=this.signedIn[t].CHAIR;break}fetch(document.url,{method:"POST",body:JSON.stringify(this.patrollers),headers:{"x-requested-with":"fetch.1",mode:"no-cors"}}).then(e=>{console.log(e.json())}),fetch(document.url,{method:"POST",body:JSON.stringify(this.signedIn),headers:{"x-requested-with":"fetch.2",mode:"no-cors"}}).then(e=>e.json())}}